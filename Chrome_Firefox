package com.Page.Compare;

import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;

import javax.imageio.ImageIO;

import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.testng.Assert;
import org.testng.ITestResult;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.AfterTest;
import org.testng.annotations.BeforeTest;
import org.testng.annotations.DataProvider;
import org.testng.annotations.Parameters;
import org.testng.annotations.Test;

import com.relevantcodes.extentreports.ExtentReports;
import com.relevantcodes.extentreports.ExtentTest;
import com.relevantcodes.extentreports.LogStatus;

public class Chrome_Firefox extends com.Page.Compare.Validation {
	WebDriver driver;
	public String Browser;
	public int i=0 , Per_Col,Excel_Length,j=1;
	String[][] Mydata;
	public Utility1 utls;
	public double diff2;
	public String Name,Link1,Link2,value;
	boolean Doc_Flag=false; 
	ITestResult result;
	ExtentReports report;
	ExtentTest logger; 
	
    @DataProvider
    public Object[][] dp() {
    	
    	  utls= new Utility1();

          Object[][] data = Utility1.getInputData("Page_Link.xlsx","Pages");
          return data;
    }

	
    @Parameters({ "old", "New","Chrome_diff","firefox_diff","IE_Diff"})
  @Test(dataProvider = "dp")
   
  public void Page_Compare(String url1,String url2,String chrome,String firefox,String IE) throws IOException, InterruptedException, InvalidFormatException {
    	 logger = report.startTest("Page Compare"); 
    	 i=i+1;
	     Link1=url1;
         Link2=url2;
       
         driver.get(Link1);
         Name=Browser+"_"+String.valueOf(i);
         Thread.sleep(1000);
        	 boolean scrollBarPresent = (boolean) ((JavascriptExecutor)driver).executeScript("return document.documentElement.scrollHeight>document.documentElement.clientHeight;");
             if(scrollBarPresent){
            	 utls.Screenshot_Chrome(driver,Name,"C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Old\\");
             }
             else{
            	 utls.Screenshot(driver,Name,"C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Old\\");
             }
        	 
        
         driver.get(Link2);
         Thread.sleep(1000);
         
       
        	 boolean scrollBarPresent1 = (boolean) ((JavascriptExecutor)driver).executeScript("return document.documentElement.scrollHeight>document.documentElement.clientHeight;");
             if(scrollBarPresent1){
            	 utls.Screenshot_Chrome(driver,Name,"C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\New\\");
             }
             else{
            	 utls.Screenshot(driver,Name,"C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\New\\");
             }
         diff2=utls.Compare("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Old\\"+Name+".png","C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\New\\"+Name+".png")*100;       
         System.out.println(" Difference :" +diff2);
         value=String.valueOf(diff2);
        	 Assert.assertEquals(0.0, diff2);
        	 logger.log(LogStatus.INFO,"Link Index :"+Name);
        	 logger.log(LogStatus.INFO,"Old URL :"+Link1);
        	 logger.log(LogStatus.INFO,"New URL :"+Link2);
        	 logger.log(LogStatus.PASS,"Screen compare percentage difference  :"+value);
        	 logger.log(LogStatus.PASS,"No Difference in the webpage");
        	 utls.WriteXLSXFile("Page_Link.xlsx","Pages",value,Per_Col,i);
       
         
	 
  }
    
    @AfterMethod
	public void getResult(ITestResult result) throws IOException, InvalidFormatException {
    	
		if (result.getStatus() == ITestResult.FAILURE) {
			
			 if(diff2==9999.9*100){
				 
				 logger.log(LogStatus.INFO,"Link Index :"+Name);
	        	 logger.log(LogStatus.INFO,"Old URL :"+Link1);
	        	 logger.log(LogStatus.INFO,"New URL :"+Link2);
	        	 logger.log(LogStatus.WARNING,"Error: Images dimensions mismatch"+value);
            	 utls.WriteXLSXFile("Page_Link.xlsx","Pages","Error: Images dimensions mismatch",Per_Col,i);
             }
        	 else{
        		
        		 logger.log(LogStatus.INFO,"Link Index :"+Name);
        		
	        	 logger.log(LogStatus.INFO,"Old URL :"+Link1);
	        	 
	        	 logger.log(LogStatus.INFO,"New URL :"+Link2);
	        	
	        	 logger.log(LogStatus.FAIL,"Screen compare percentage difference  :"+value);
	        	
	        	 logger.log(LogStatus.FAIL, "Old Image  "+ logger.addScreenCapture("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Old\\"+Name+".png"));
	        	 
	        	 logger.log(LogStatus.FAIL, "New Image  " + logger.addScreenCapture("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\New\\"+Name+".png"));
	        	 logger.log(LogStatus.FAIL, "Compare Image  " + logger.addScreenCapture("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Compare\\"+Name+".png"));
	        	 
       		 utls.WriteXLSXFile("Page_Link.xlsx","Pages",value,Per_Col,i);
       	
       		 BufferedImage img3=utls.Get_diff("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Old\\"+Name+".png","C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\New\\"+Name+".png");
                File outputfile = new File("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Compare\\"+Name+".png");
                ImageIO.write(img3, "PNG", outputfile);
                utls.createWord("C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Doc\\", Name, Link1, Link2,"C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Old\\"+Name+".png", "C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\New\\"+Name+".png", "C:\\Users\\pradeep_k02\\Desktop\\Page_SS\\Compare\\"+Name+".png");
			
		}
			 
			 

	} 
		report.endTest(logger);
		
    }
  
  
  
 
  
  @BeforeTest
  @Parameters({"Browser"})
  public void beforeClass(String browser) throws IOException, InterruptedException {
	  report = new ExtentReports(System.getProperty("user.dir")+"/Advnc_Report/Report.html",true); 
	  Browser=browser;
	  driver=Setup(driver,Browser);
	  utls= new Utility1();
	  Mydata=utls.readXLSXFile("Page_Link.xlsx","Pages");
	  Excel_Length=Mydata[0].length;
		 System.out.println("Excel Read Done");
		 
		 if(Browser.equalsIgnoreCase("Chrome")){
				
				 Per_Col=2;
			}
		 if(Browser.equalsIgnoreCase("Firefox")){
				
			 Per_Col=3;
		}
		 
		 if(Browser.equalsIgnoreCase("IE")){
				
			 Per_Col=4;
		}
  	
  }
  
  @AfterTest
	public void afterClass() {
		
		
		report.flush();
		report.close();
		driver.close();
	} 

 
}

